name: 'oxs-check-updates'
description: 'Checks the updated files in a PR and give the folders from the files back.'

branding:
  icon: log-in
  color: 'blue'

inputs: 
  searchFolder:
    description: 'The folder in which the updated files will be checked.'
    required: true

outputs:
  folders:
    description: 'The folders in which the files was changed.'

runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Get changed files in the selected folder
      id: changed-files-folder
      uses: tj-actions/changed-files@v45
      with:
        files: ${{ inputs.searchFolder }}/**

    - name: Extract changed folders and store in env variable
      shell: bash
      run: |
        declare -A non_manifest_count
        FOLDERS=()
    
        for file in ${{ steps.changed-files-folder.outputs.all_changed_files }}; do
          folder=$(echo "$file" | cut -d'/' -f2)
          filename=$(basename "$file")
    
          # Count only NON-manifest files
          if [[ "$filename" != "manifest.json" ]]; then
            ((non_manifest_count["$folder"]++))
          fi
        done
    
        for folder in "${!non_manifest_count[@]}"; do
          # Include folder only if at least one non-manifest file changed
          if [[ ${non_manifest_count["$folder"]} -gt 0 ]]; then
            FOLDERS+=("$folder")
          fi
        done
    
        echo "folders=${FOLDERS[*]}" >> "$GITHUB_ENV"
